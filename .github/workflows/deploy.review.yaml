name: Deployment to review environment
on: 
    push:
       branches:
            - main
    workflow_dispatch:

env:
    SSH_AUTH_SOCK: /tmp/ssh_agent.sock

jobs:
  deploy-review:
    name: Deploying to review environment
    runs-on: ubuntu-latest
    env: 
      NEXT_PUBLIC_API_URL: ${{ secrets.REVIEW_API_URL }}
    steps:
    - uses: actions/checkout@master
      with:
            ref: ${{ github.ref }}

    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
            node-version: '20.x'

    - name: Install dependencies
      run: npm ci

    - name: Build website
      run: npm run build

    - name: 'Create private key file'
      run: echo "${{ secrets.PRIVATE_KEY_REVIEW }}" > ./private_key && chmod 600 ./private_key

    - name: Setup SSH connection
      run: >
        echo '#!/bin/sh' >> ./passphrase_script.sh &&
        echo "echo ${{ secrets.PASSPHRASE_REVIEW }}" >> ./passphrase_script.sh &&
        chmod +x ./passphrase_script.sh

    - run: ssh-agent -a $SSH_AUTH_SOCK > /dev/null
    - run: DISPLAY=1 SSH_ASKPASS='./passphrase_script.sh' ssh-add ./private_key < /dev/null

    - name: Copy files to host
      run: rsync -avz -e 'ssh -o StrictHostKeyChecking=accept-new -p ${{ secrets.PORT_REVIEW }}' ./.next ./node_modules ${{ secrets.USERNAME_REVIEW }}@${{ secrets.HOST_REVIEW }}:${{ secrets.REMOTE_PATH }}/coupcritique-front/.next

    - name: Restart PM2
      run: >
        ssh -p ${{ secrets.PORT_REVIEW }} ${{ secrets.USERNAME_REVIEW }}@${{ secrets.HOST_REVIEW }} -o StrictHostKeyChecking=no
        "cd ${{ secrets.REMOTE_PATH }}/coupcritique-front && pm2 reload all"
